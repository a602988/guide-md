# 機制說明

## 登入 {#登入}

* **登出時清除 Session**：登出時，將會全部清除此網站的 Session。若您同時有後台登入，將會一併登出。

## SEO 設定 {#seo設定}

優先順序：會先以資料內的 SEO主 > 次為選單設定 > 網站基本設定

## 語系國家 {#語系國家}

* **自動判斷語系**：依據使用者 IP 判斷國家，自動顯示語系、貨幣、國家 (依實際設計需求顯示)。 (功能請參見：[國家管理](/guide/world-country))
* **購物車國家階層選擇**：洲區單獨建立僅有一個時，前端網頁則會自動省略。 (功能請參見：[小國家無洲區時設定](/guide/world-state#小國家無洲區時設定))

## 商品建置 {#商品建置}

* **商品分類：** 若依據會員等級、商品顯示不顯示與否等..判別後，底下無商品，則分類不顯示。此功能依據各專案會有所變動。
* **商品庫存不顯示：** 當商品無庫存時，將會不顯示於列表，也無法透過網址瀏覽，視同下架功能。
* **庫存不足判別**：比對包含 `商品管理->價格組合：組合限量`與`商品管理->品項管理：庫存`、各促銷的限定等

## 促銷相關 {#促銷相關}

* **商品不適用促銷時：** 當商品已於活動促銷中使用，卻於日後設定為不適用該促銷模組時，則視同無法使用。
* **促銷活動值：** 訂單送出時，僅判斷已符合活動是否停用需回購物車判斷，針對活動內容異動，則已當下使用者加入購物車時促銷活動設定為主，無法判斷促銷活動內容異動後條件。

## 訂單 {#訂單}

* 無效訂單 用於非使用者行為的取消，此不計入失敗訂單統計等

## 退貨 {#退貨}

* **不可退貨商品：** 當可退貨與不可退貨商品，同因活動促銷關係為群組或整體退貨之狀況時，則都可退貨。

## 購物車 {#購物車}

*  **上次訂單紀錄：** 會員在購買結帳時，可以在結帳頁面，記住上一次的付款方式、出貨方式、出貨地址、出貨人等，在結帳頁時直接帶入
*  **跨平台購物車保淳：** 未結帳購物車，將會儲存於網站，不論使用什麼裝置，都會帶入您上次未結帳的購物車

## 瀏覽紀錄 {#瀏覽紀錄}

*  單一 IP，每筆資料一天僅計算一次點擊

## 折扣說明與計算規則 {#折扣說明與計算規則}

* **欄位：排序**：促銷折扣排序數字越小，前端介面優先排序顯示，促銷符合後，小於符合條件的促銷排序，都不顯示。例如以下：則排序1不顯示。
  * 排序：1.滿20件折5%(不符合) => 不顯示
  * 排序：2.滿30件折7%(已符合)
  * 排序：3.滿40件折10%(不符合)
  
* **欄位：適用範圍**：`會員群組`、`會員標籤`、`商品賣場`、`商品品牌`、`商品分類`、`適用商品`，若同時設定，則為交集。  
  例如：設定A分類、B商品，則僅限A分類下的B商品可符合，A分類下其他商品都不符合。
* **商品級與訂單級折扣**：若設定 `商品品牌`、`商品分類`、`適用商品 `則為商品級促銷。沒有設定，則為訂單級(整體訂單折扣)。
* **訂單級折扣**：為**商品級折完後**加總計算，若商品本身有設定不參加任何促銷，金額也不會加總於**商品級折完後**的金額計算內。再依據訂單級折扣順序折上折。

* **欄位：重複計算**：
  * 停用：無法與同模組或其他模組促銷折扣活動併。
  * 重複：同模組促銷可併用優惠，但僅設定**重複**的可跟**重複**的併用，無法與**停用**的併用。
  * 強制同類：同模組促銷**停用**、**重複**，都可強制併用。
  * 強制跨類：**同模組**促銷不可併用，**不同促銷模**組可併用。
  * 同類併跨類：同模組促銷可強制併用，不同促銷模組也可併用。

* **欄位：特殊情境**
  * 無：無任何情劑。
  * 首購：註冊後第一次購買，僅限一次。
  * 當月生日：當月月初到月底生日都可以使用，不限制次數，若要有限制，請設定欄位：間隔天數->99999天。
  * 當天生日：僅當天生日可用，不限制次數，若要有限制，請設定欄位：間隔天數->99999天。
  * 當周生日：是以每週一為第一天，週日為最後一天，不限制次數，若要有限制，請設定欄位：間隔天數->99999天。
  * 會員升等：需指定會員等級，並於升等到該等級後可使用，不限制次數，若要有限制，請設定欄位：間隔天數->99999天。
  * 會員續等：需指定會員等級，並於續等到該等級後可使用，不限制次數，若要有限制，請設定欄位：間隔天數->99999天。
  
* **跨類計算順序**：依據下列`商品級 、促銷級`計算順序，往前併用。
* **活動專區**：使用專區的活動，將僅會於專區頁面計算好活動才能加入購物車，並於購物車優先符合計算，再依據其他促銷倒序計算。若非從專區頁面而進入購物車，則依據活動本身排序正常計算。

* **折扣計算**：無條件捨去小數
* **優先計算**：促銷折扣`排序`數字越大，越優先計算
* **折上折**：依據下列`商品級 、促銷級`計算順序與`計算`說明，做折上折 。
* **攤算**：先計算折扣商品價總額，計算出折扣金額，在推算於各商品金額佔比計算。
* **商品不足扣**：將會依據倒序先扣除，當商品折為０元不足扣除促銷金額時，則扣除均攤推算在其他同促銷商品。

### 商品級計算規則 {#商品級計算規則}

| 計算順序 | 促銷模組  | 適用商品 | 不可併用時排除模組 | 計算 | 併用設定 |
| --- | --- | --- | --- | --- | --- |
| 1 | 配搭優惠 | 一般商品 | 無 | 商品售價 | 無 |
| 2 | 兌禮活動 | 兌禮商品 | 無 | 依據活動設定 | 無 |
| 3 | 數量優惠 | 一般商品 | 配搭 | 商品售價 | 無 |
| 4 | 折價卷 | 一般商品 | 配搭、兌禮、數量 | 商品售價- 配搭優惠 -  數量優惠 | 可 |
| 5 | 折扣活動 | 一般商品 | 配搭、兌禮、數量、折價券 | 商品售價- 配搭優惠 -  數量優惠 - 折價卷 | 可 |
| 6 | 贈品活動 | 一般商品 | 配搭、兌禮、數量、折扣、折價券 | 商品售價- 配搭優惠 -  數量優惠 - 折價卷 - 折扣活動 | 可 |
| 7 | 加購活動 | 加購商品 | 無 | 商品售價- 配搭優惠 -  數量優惠 - 折價卷 - 折扣活動+贈品(數量) | 無 |
| 8 | 等級優惠 | 一般商品 | 配搭、兌禮、數量、折扣、贈品、折價券 | 商品售價- 配搭優惠 -  數量優惠 - 折價卷 - 折扣活動 | 可 |

**商品級計算規則說明：**

* 配搭優惠、兌禮活動、數量優惠、加購：此三項不可併用
* 兌禮活動、加購：無法無其他促銷模組並用
* 折價卷：無法併用 `兌禮活動、加購` 的商品。當設定為可併用時，符合條件與折扣計算都以`商品售價- 配搭優惠 -  數量優惠`計算，為折上折。
* 折扣活動：無法併用 `兌禮活動、加購`的商品。當設定為可併用時，符合條件與折扣計算都以 `商品售價- 配搭優惠 -  數量優惠 - 折價卷` 計算，為折上折。
  * 部分折扣：以最低單價金額的為折扣，但折於高單價商品
* 贈品活動：無法併用 `兌禮活動、加購` 的商品。當設定為可併用時，符合條件以 `商品售價- 配搭優惠 -  數量優惠 - 折價卷 - 折扣活動` 計算，為折上折。
* 加購活動：無法併用，折扣計算以 `商品售價` 計算，符合條件以 `商品售價- 配搭優惠 -  數量優惠 - 折價卷 - 折扣活動+贈品(數量)，`計算，但商品級加購上去的商品，將不計算於商品加購活動條件金額。
* 等級優惠：無法併用 `兌禮活動、加購` 的商品。當設定為可併用時，符合條件與折扣計算都以 `商品售價- 配搭優惠 -  數量優惠 - 折價卷 - 折扣活動` 計算，為折上折。

### 訂單級計算規則 {#訂單級計算規則}

| 計算順序 | 促銷模組  | 適用商品 | 不可併用時排除模組 | 計算 | 併用設定 |
| --- | --- | --- | --- | --- | --- |
| 1 | 加購活動 | 一般商品、加購品 | 贈送品、加購品 | 商品折扣後金額小計 | 無 |
| 2 | 折價卷 | 一般商品、加購品 | 無 | 商品折扣後金額小計-加購活動 | 可 |
| 3 | 折扣活動 | 一般商品、加購品、兌禮品 | 折價券 | 商品折扣後金額小計 - 加購活動 - 折價卷 | 可 |
| 4 | 贈品活動 | 一般商品、加購品、兌禮品 | 折扣、折價券 | 商品折扣後金額小計 - 加購活動 - 折價卷 - 折扣 | 可 |
| 5 | 等級優惠 | 一般商品 | 折扣、贈品、折價券、商品級(配搭、兌禮、數量、折價券、折扣、贈品) | 商品折扣後金額小計 - 加購活動 - 折價卷 - 折扣 + 贈品(數量) | 可 |
| 6 | 點數折抵 | 一般品、加購品、兌禮品 | 無 | 商品折扣後金額小計 - 加購活動 - 折價卷 - 折扣 + 贈品(數量) - 等級 | 無 |

**訂單級計算規則說明：**

*  **加購活動**：折扣計算以`商品售價` 計算，符合條件以 `商品數量or折扣後金額小計`計算，但商品級加購上去的商品，將不計算於商品加購活動條件金額。
*  **折價卷**：當設定為可併用時，符合條件與折扣計算都以 `商品折扣後金額小計-加購活動`計算，
*  **折扣活動**：當設定為可併用時，符合條件與折扣計算都以 `商品折扣後金額小計 - 加購活動 - 折價卷`計算，
*  **贈品活動**：當設定為可併用時，符合條件以 `商品折扣後金額小計 - 加購活動 - 折價卷 - 折扣`計算，
*  **等級優惠**：當設定為可併用時，符合條件以 `商品折扣後金額小計 - 加購活動 - 折價卷 - 折扣`計算，
*  **點數折抵**：當設定為可併用時，符合條件以 `商品折扣後金額小計 - 加購活動 - 折價卷 - 折扣 + 贈品(數量) - 等級`計算，

##  事件通知信件觸發與發送 {#事件通知信件觸發與發送}

| 通知名稱 | 觸發與發送說明 |
| --- | --- |
| 後臺系統 - 登入兩階段驗證通知信 | 後臺進行登入過程發送 |
| 會員註冊 - 註冊完成通知信 | 前臺註冊成功時觸發 |
| 會員服務 - 註冊驗證碼 | 前臺註冊過程發送 |
| 會員服務 - 等級即將到期 | 系統排程發送 |
| 會員服務 - 會員降等 | 後臺操作會員等級或系統排程變動等級時觸發 |
| 會員服務 - 會員升等 | 後臺操作會員等級或系統排程變動等級時觸發 |
| 會員服務 - 忘記密碼驗證碼 | 前臺操作忘記密碼時發送 |
| 會員服務 - 重設密碼 | 前臺成功重設密碼時發送 |
| 商品管理 - 商品補貨通知 | 後臺變動商品庫存觸發 QuantityChanged (庫存變動) 事件 |
| 商品管理 - 品項庫存量過低 | 系統排程發送。 |
| 商品管理 - 商品降價通知 | 系統排程發送 |
| 訂單 - 訂單已確認通知 | 前臺訂單儲存時觸發 |
| 訂單 - 訂單取消通知 | 前臺取消訂單或後臺取消訂單觸發 |
| 訂單 - 訂單無效通知 | 後臺將訂單改為無效時發送 |
| 訂單 - 待付款訂單通知 | 系統排程發送 |
| 訂單 - 付款成功通知 | 後臺將金流單設為已付款或第三方金流回覆訊息為已付款時觸發。即時付款型態的金流不通知，例如刷卡、linepay、appley pay等。後台操作付款完成，通知的付款方式類型為：現金、ATM、超商、貨到付款。綠界：是設定為"現金"的付款種類才通知。 |
| 訂單 - 訂單過期未付款通知 | 系統排程發送 |
| 訂單 - 訂單完成邀請評價通知 | 系統排程發送 |
| 購物車 - 提醒結帳通知 | 系統排程發送 |
| 物流 - 出貨完成通知 | 後臺將物流單設為已出貨時觸發 (第三方物流狀態更新透過 Repository 觸發) |
| 物流 - 商品可取貨通知 | 後臺將物流單設為待取貨時發送 (第三方物流狀態更新透過 Repository 發送) |
| 物流 - 商品到貨通知 | 後臺將物流單設為已到貨時觸發 (第三方物流狀態更新透過 Repository 觸發) |
| 物流 - 商品未取退回通知 | 後臺將物流單設為已退回時觸發 (第三方物流狀態更新透過 Repository 觸發) |
| 物流 - 退貨商品已派車通知 | 後臺退貨物流單設為已出貨時發送 |
| 物流 - 退貨商品已退回通知 | 後臺退貨物流單設為已退回時發送 |
| 退貨 - 退貨申請通知 | 前臺建立退貨單或後臺建立退貨單時觸發 |
| 退貨 - 退貨受理通知 | 後臺將退貨單設為處理中時觸發 |
| 退貨 - 退貨退款通知 | 後臺將退貨單設為已退款時觸發 |
| 退貨 - 退貨申請取消通知 | 後臺將退貨單設為已取消時觸發 |
| 退貨 - 退貨完成通知 | 後臺將退貨單設為已完成時觸發 |
| 折價券 - 折價券獲得通知 | 系統排程送出折價券時發送(僅事件屬於自動的才發送通知) |
| 折價券 - 即將於 7 天後到期通知 | 系統排程發送 |
| 折價券 - 折價券到期通知 | 系統排程發送 |
| 點數 - 點數獲得通知 | 前臺給點或系統排程給點時發送 |
| 點數 - 點數失效通知 | 系統排程發送 |
| 點數 - 即將到期前 1 天通知 | 系統排程發送 |
| 點數 - 即將到期前 7 天通知 | 系統排程發送 |
| 客服中心 - 聯絡表單通知 | 前臺發送聯絡表單時觸發 |
| 發票 - 發票開立通知 | 後臺將發票設為已開立時觸發 |
| 發票 - 發票作廢通知 | 後臺將發票設為已作廢時觸發 |
| 發票 - 發票中獎通知 | 後臺將發票設為已中獎或系統排程對獎時觸發 |
| 發票 - 折讓單開立通知 | 後臺將折讓單設為已開立時觸發 |
| 發票 - 折讓單作廢通知 | 後臺將折讓單設為已作廢時觸發 |
| 發票 - 字軌不足 | 建立發票自動取號時若字軌不足則觸發 |
| 第三方服務 - 黑貓託運號碼不足 | 系統排程派單時若單號不足則發送 |

## 排程時間 {#排程時間}

此為系統預設，專案若有更改，將以實際設定為主

| 排程項目 | 執行頻率 |
| --- | --- |
| 寄送佇列Email&簡訊 | 每分 |
| 佇列中點數給點 | 每分 |
| 自動點數事件發送 (會將點數送至佇列) | 00:00 / 每日 |
| 自動清除過期點數 | 00:00 / 每日 |
| 點數明日過期通知 | 00:00 / 每日 |
| 點數7日後過期通知 | 00:00 / 每日 |
| 自動取消訂單 | 00:00 / 每日 |
| 自動完成訂單 | 00:00 / 每日 |
| 自動折價券事件 | 00:00 / 每日 |
| 折價券過期通知 | 00:00 / 每日 |
| 折價券7日後過期通知 | 00:00 / 每日 |
| 自動會員等級事件 | 00:00 / 每日 |
| 自動未結帳購物車通知 | 00:00 / 每日 |
| 自動未付款通知 | 00:00 / 每日 |
| 自動未付款過期 | 00:00 / 每日 |
| 邀請訂單評價通知 | 00:00 / 每日 |
| 會員等級到期通知 (降級提醒) | 00:00 / 每日 |
| 自動會員黑名單 | 00:00 / 每日 |
| 發票自動對獎 | 00:00 / 每日 |
| 電子報發送 (會送至佇列) | 每分 |
| 寄送佇列電子報&簡訊 | 每5分 |
| 商品庫存不足通知 | 00:00 / 每日 |
| 自動拋轉發票開立 | 每小時 |
| 自動拋轉折讓單開立 | 每小時 |
| 自動發票對獎 | 27日 / 每月 (單數月) |
| 上傳物流新單 | 13:30 / 每日 |
| 下載更新物流貨態 | 14:30 / 每日 |
| 上傳物流新單 | 13:30 / 每日 |
| 下載更新物流貨態 | 14:30 / 每日 |
